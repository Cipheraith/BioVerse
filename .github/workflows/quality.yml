name: Code Quality

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  # Code coverage
  code-coverage:
    name: Code Coverage Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install server dependencies
      working-directory: ./server
      run: npm ci

    - name: Run tests with coverage
      working-directory: ./server
      run: npm run test:coverage
      env:
        JWT_SECRET: test_jwt_secret_for_ci
        PGDATABASE: bioverse_test_db
      continue-on-error: true

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./server/coverage/lcov.info
        flags: server
        name: server-coverage
      continue-on-error: true

  # Code complexity analysis
  code-complexity:
    name: Code Complexity Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install complexity analyzer
      run: npm install -g complexity-report

    - name: Analyze complexity
      run: |
        echo "Analyzing code complexity..."
        find server/src client/src -name "*.js" -o -name "*.ts" | head -20
      continue-on-error: true

  # Dead code detection
  dead-code-detection:
    name: Dead Code Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        cd client && npm ci && cd ..
        cd server && npm ci && cd ..

    - name: Detect unused exports (Client)
      working-directory: ./client
      run: |
        npx ts-prune || echo "ts-prune check completed"
      continue-on-error: true

    - name: Find TODO/FIXME comments
      run: |
        echo "Searching for TODO/FIXME comments..."
        grep -r "TODO\|FIXME" --include="*.js" --include="*.ts" --include="*.py" server/ client/ python-ai/ || echo "No TODOs found"
      continue-on-error: true

  # Documentation check
  documentation-check:
    name: Documentation Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check README files
      run: |
        echo "Checking for essential documentation..."
        [ -f "README.md" ] && echo "‚úÖ README.md" || echo "‚ùå Missing README.md"
        [ -f "CONTRIBUTING.md" ] && echo "‚úÖ CONTRIBUTING.md" || echo "‚ùå Missing CONTRIBUTING.md"
        [ -f "LICENSE" ] && echo "‚úÖ LICENSE" || echo "‚ùå Missing LICENSE"
        [ -f "SECURITY.md" ] && echo "‚úÖ SECURITY.md" || echo "‚ùå Missing SECURITY.md"

    - name: Check API documentation
      run: |
        echo "Checking API documentation..."
        grep -r "swagger\|openapi" server/ python-ai/ && echo "‚úÖ API docs configured" || echo "‚ö†Ô∏è No API docs found"

  # Performance benchmarks
  performance-check:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      working-directory: ./server
      run: npm ci

    - name: Run performance tests
      working-directory: ./server
      run: |
        if [ -f "scripts/performance-test.js" ]; then
          npm run perf:test:quick || echo "Performance tests need optimization"
        else
          echo "No performance tests configured"
        fi
      continue-on-error: true

  # Dependency health check
  dependency-health:
    name: Dependency Health Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Check for outdated packages (Client)
      working-directory: ./client
      run: |
        npm install
        npm outdated || echo "Some packages are outdated"
      continue-on-error: true

    - name: Check for outdated packages (Server)
      working-directory: ./server
      run: |
        npm install
        npm outdated || echo "Some packages are outdated"
      continue-on-error: true

    - name: Check package sizes
      run: |
        echo "Checking package.json sizes..."
        wc -l package.json client/package.json server/package.json

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [code-coverage, code-complexity, dead-code-detection, documentation-check, performance-check, dependency-health]
    if: always()
    permissions: {}
    steps:
    - name: Generate Quality Report
      run: |
        echo "# üìä BioVerse Code Quality Summary"
        echo ""
        echo "## Quality Metrics:"
        echo "- Code Coverage: ${{ needs.code-coverage.result }}"
        echo "- Code Complexity: ${{ needs.code-complexity.result }}"
        echo "- Dead Code Detection: ${{ needs.dead-code-detection.result }}"
        echo "- Documentation: ${{ needs.documentation-check.result }}"
        echo "- Performance: ${{ needs.performance-check.result }}"
        echo "- Dependencies: ${{ needs.dependency-health.result }}"
        echo ""
        echo "‚úÖ Quality analysis complete"
